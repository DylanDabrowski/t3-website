name: Exhibit Component Previews

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  previews:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PREVIEW_UPLOAD_URL: ${{ secrets.PREVIEW_UPLOAD_URL }}
      PREVIEW_UPLOAD_TOKEN: ${{ secrets.PREVIEW_UPLOAD_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable corepack
        run: corepack enable

      - name: Detect package manager
        id: detect_pm
        shell: bash
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "pm=pnpm" >> "$GITHUB_OUTPUT"
            echo "install=pnpm install --frozen-lockfile" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -f yarn.lock ]; then
            if [ -f .yarnrc.yml ]; then
              echo "pm=yarn" >> "$GITHUB_OUTPUT"
              echo "install=yarn install --immutable" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "pm=yarn" >> "$GITHUB_OUTPUT"
            echo "install=yarn install --frozen-lockfile" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "pm=npm" >> "$GITHUB_OUTPUT"
          echo "install=npm ci" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        shell: bash
        run: |
          set +e
          PM="${{ steps.detect_pm.outputs.pm }}"
          INSTALL_CMD="${{ steps.detect_pm.outputs.install }}"

          if [ "$PM" = "npm" ]; then
            npm ci
            STATUS=$?
            if [ $STATUS -ne 0 ]; then
              npm install
              STATUS=$?
            fi
            if [ $STATUS -ne 0 ]; then
              npm ci --legacy-peer-deps
              STATUS=$?
            fi
            if [ $STATUS -ne 0 ]; then
              npm install --legacy-peer-deps
              STATUS=$?
            fi
            if [ $STATUS -ne 0 ]; then
              exit $STATUS
            fi
          else
            $INSTALL_CMD
          fi

          if [ "$PM" = "pnpm" ]; then
            pnpm add -D vite @vitejs/plugin-react playwright tailwindcss postcss autoprefixer
          elif [ "$PM" = "yarn" ]; then
            yarn add -D vite @vitejs/plugin-react playwright tailwindcss postcss autoprefixer
          else
            npm install -D vite @vitejs/plugin-react playwright tailwindcss postcss autoprefixer
          fi

          npx playwright install --with-deps

      - name: Generate previews
        run: node scripts/exhibit-preview.js
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          PREVIEW_UPLOAD_URL: ${{ env.PREVIEW_UPLOAD_URL }}
          PREVIEW_UPLOAD_TOKEN: ${{ env.PREVIEW_UPLOAD_TOKEN }}
